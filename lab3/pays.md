# Платежная система

## Задание

Hазработать приложение–клиент и приложение–сервер платежной системы. Участники платежной системы имеют электронные кошельки. Электронный кошелек имеет уникальный номер. При регистрации пользователя в платежной системе на его счет зачисляется определенная сумма. Пользователя платежной системы могут осуществлять платежи друг другу через приложение–сервер.

### Серверная часть

Серверное приложение должно реализовывать следующие функции:

1. Прослушивание определенного порта
2. Обработка запросов на подключение по этому порту от клиентов платежной системы
3. Поддержка одновременной работы нескольких клиентов платежной системы через механизм нитей
4. Прием запросов от клиента на регистрацию пользователя, передачу списка электронных кошельков пользователей платежной системы, осуществление платежей одного пользователя другому, проверка состояния счета кошелька
5. Осуществление добавления пользователя в платежную систему, хранение и изменение состояния электронных кошельков в зависимости от платежей пользователей
6. Передача запросов на платежи от одного пользователя другому, подтверждений платежей, номера нового кошелька при регистрации пользователя, списка электронных кошельков
7. Обработка запроса на отключение клиента
8. Принудительное отключение клиента

### Клиентская часть

Клиентское приложение должно реализовывать следующие функции:

1. Установление соединения с сервером
2. Передача запросов на передачу списка электронных кошельков пользователей платежной системы, платежи одного пользователя другому, проверку состояния счета кошелька
3. Получение от сервера запросов на платеж от другого пользователя, результатов платежа
4. Разрыв соединения
5. Обработка ситуации отключения клиента сервером

## Протокол

Протокол использует [общий формат](shared-proto.md) кодирования данных.

В TCP сессии хранится номер кошелька, если была произведена авторизация с помощью запросов *Register* или *Login*.

### Описание пакетов

#### *Register*

ID запроса: 1

ID ответа: 2

Регистрация кошелька.

В теле пакета запроса содержится тип **string**, который означает пароль.

В теле пакета ответа содержатся поля **uint32** (ID кошелька) и **Unsigned LEB128** (количество денег на счёте).

#### *Login*

ID запроса: 3

ID ответа: 4

Открытие существующего в системе кошелька.

В теле пакета запроса содержатся поля **uint32** (ID кошелька) и **string** (пароль кошелька).

В теле пакета ответа содержится поле **Unsigned LEB128** (количество денег на новом счёте).

#### *Wallets*

ID запроса: 5

ID ответа: 6

Получение списка существующих в системе кошельков и количества денег на счёте, если была произведена авторизация.

Список кошельков **wallets_list** закодирован как последовательность полей **uint32** (ID очередного кошелька) с префиксом **Unsigned LEB128** (количество элементов последовательности).

В теле пакета запроса нет полей.

В теле пакета ответа содержится поле **wallets_list** (список кошельков в системе) и **Unsigned LEB128** (количество денег на текущем счёте, если авторизации не было, то это поле равно `0`).

#### *Transaction*

ID запроса: 7

ID ответа: 8

Перевод денег с текущего счёта на указанный в запросе. Этот запрос требует пройденную авторизацию.

В теле пакета запроса содержатся поля **uint32** (ID кошелька) и **Unsigned LEB128** (количество денег которые следует перевести).

В теле пакета ответа нет дополнительных данных. Если этот пакет был получен, то операция прошла успешно, иначе придёт пакет *Error* с текстом ошибки. 

## Сервер

Выполнил Антон Натура.

Сервер запускается командой:

    ./pays-server [--host <address>] [--port <port>] [--money <money>]

Адрес хоста задаётся опцией **--host**, номер порта опцией **--port**.

По умолчанию address = `localhost` и port = `4242`.

Опция **--money** задаёт начальное количество денег на каждом новом счёте (по умолчанию имеет значение `1337`).

## Клиент

Выполнил Николай Голзицкий.

Для работы клиента необходим модуль Python [py-cui](https://github.com/jwlodek/py_cui).

Установка модуля:

    pip3 install -r requirements.txt

Клиент запускается командой:

    ./pays-client [--host <address>] [--port <port>]

Смысл и значения по умолчанию у опций данной команды аналогичны тем, что в программе сервера.

После удачного подключения клиент отображает в терминале окно со списком кошельков (Wallets), а также виджеты с номером текущего кошелька (My Wallet) и состоянием текущего счёта (Money).

Доступны кнопки Login для использования существующего кошелька и Register для создания нового. Эти кнопки вызовут соответствующие формы, которые следует заполнить, чтобы произвести эти операции.

Существует кнопка Refresh, которая обновляет список кошельков и состояние текущего счёта (если был выполнен вход).

Для перевода денег на другой счёт следует выбрать номер кошелька из списка кошельков (Wallets). Для этого нужно сфокусироваться на виджете Wallets и выбрать стрелочками нужный кошелёк. После этого следует нажать Enter и в открывшейся форме ввести количество денег, которое будет переведено на выбранный счёт.

Выход из приложения осуществляется нажатием клавиши **q** (работает, когда нет фокусировки на виджете) или сочетанием клавиш **Ctrl+C**.

Перемещение между виджетами осуществляется стрелочками на клавиатуре. Расфокусировка виджета осуществляется клавишей **ESC**. Фокусировка клавишей **Enter**.
